name: golintr
author: norwd
description: "Lint your code using golint"

branding:
  icon: check-circle
  color: green

inputs:
  path:
    description: 'Path used by golint command'
    required: false
    default: './...'

outputs:
  errors:
    description: 'The golint output if the command fail'
    value: ${{ steps.golint.outputs.errors }}

runs:
  using: composite
  steps:
    - id: install
      name: "Install `golint`"
      shell: bash
      run: go install golang.org/x/lint/golint@latest

    - id: golint
      name: "Run `golint`"
      shell: bash
      env:
        GOLINT_PATH: ${{ inputs.path }}
      run: |
        echo "errors<<EOF" >> "${GITHUB_OUTPUT}"
        { ~/go/bin/golint -set_exit_status "${GOLINT_PATH}" || true; } | tee -a "${GITHUB_OUTPUT}"
        echo "EOF" >> "${GITHUB_OUTPUT}"

    - if: steps.golint.outputs.errors != ''
      name: "Display Errors"
      shell: bash
      env:
        GOLINTR_ERRORS: ${{ steps.golint.outputs.errors }}
        AWK_SCRIPT: |
          {
            file=$1
            line=$2
            title="Go Lint Error"

            $1=""
            $2=""
            $3=""

            print "::error file=" file ",line=" line ",title=" title "::" $0
          }
      run: |
        echo "$GOLINTR_ERRORS" | awk -F : "${AWK_SCRIPT}"
        exit 1
